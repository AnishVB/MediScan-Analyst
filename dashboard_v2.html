<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MediScan Analyst - Advanced Medical Image Analysis</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen",
          "Ubuntu", sans-serif;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        color: #2c3e50;
        min-height: 100vh;
      }

      .app-container {
        display: flex;
        min-height: 100vh;
      }

      /* SIDEBAR NAVIGATION */
      .sidebar {
        width: 260px;
        background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.15);
        padding: 30px 20px;
        position: fixed;
        height: 100vh;
        overflow-y: auto;
        z-index: 1000;
      }

      .app-logo {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 30px;
        color: white;
        font-size: 20px;
        font-weight: 700;
        padding-bottom: 20px;
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
      }

      .app-logo-icon {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 16px;
      }

      .nav-menu {
        list-style: none;
      }

      .nav-item {
        margin-bottom: 8px;
      }

      .nav-link {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 15px;
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
      }

      .nav-link:hover,
      .nav-link.active {
        background: rgba(102, 126, 234, 0.2);
        color: #667eea;
        transition: all 0.3s ease;
      }

      .nav-icon {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* MAIN CONTENT */
      .main-content {
        margin-left: 260px;
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      /* HEADER */
      header {
        background: white;
        border-bottom: 1px solid #e0e6ed;
        padding: 20px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .breadcrumb {
        display: flex;
        gap: 8px;
        font-size: 13px;
        color: #7f8c8d;
      }

      .breadcrumb span {
        color: #667eea;
        font-weight: 600;
      }

      .page-title {
        font-size: 24px;
        font-weight: 700;
        color: #2c3e50;
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .user-badge {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 15px;
        background: #f5f7fa;
        border-radius: 6px;
        font-size: 13px;
        color: #7f8c8d;
      }

      .user-avatar {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
      }

      /* CONTENT AREA */
      .content-area {
        flex: 1;
        padding: 30px;
        overflow-y: auto;
      }

      .page {
        display: none;
      }

      .page.active {
        display: block;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* CARDS */
      .card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        padding: 24px;
        margin-bottom: 20px;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #ecf0f1;
      }

      .card-title {
        font-size: 18px;
        font-weight: 600;
        color: #2c3e50;
      }

      /* GRID LAYOUTS */
      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .grid-3 {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
      }

      .grid-4 {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
      }

      /* STAT CARDS */
      .stat-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        border-left: 4px solid #667eea;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      }

      .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: #667eea;
        margin-bottom: 5px;
      }

      .stat-label {
        font-size: 13px;
        color: #7f8c8d;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      /* BUTTONS */
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
      }

      .btn-secondary {
        background: #ecf0f1;
        color: #2c3e50;
      }

      .btn-secondary:hover {
        background: #bdc3c7;
      }

      .btn-success {
        background: #10b981;
        color: white;
      }

      .btn-success:hover {
        background: #059669;
      }

      .btn-danger {
        background: #ef4444;
        color: white;
      }

      .btn-danger:hover {
        background: #dc2626;
      }

      /* FORMS */
      .form-group {
        margin-bottom: 15px;
      }

      .form-label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        color: #2c3e50;
        font-size: 13px;
      }

      .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #e0e6ed;
        border-radius: 6px;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .form-control:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      textarea.form-control {
        resize: vertical;
        min-height: 100px;
      }

      /* UPLOAD AREA */
      .upload-area {
        border: 2px dashed #667eea;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: rgba(102, 126, 234, 0.05);
      }

      .upload-area:hover {
        background: rgba(102, 126, 234, 0.1);
        border-color: #764ba2;
      }

      .upload-area.dragover {
        background: rgba(102, 126, 234, 0.15);
        border-color: #764ba2;
        transform: scale(1.02);
      }

      .upload-icon {
        font-size: 48px;
        margin-bottom: 15px;
      }

      .upload-text {
        font-size: 14px;
        color: #2c3e50;
        margin-bottom: 5px;
      }

      .upload-hint {
        font-size: 12px;
        color: #7f8c8d;
      }

      /* TABLES */
      .table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      .table th {
        background: #f5f7fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #7f8c8d;
        border-bottom: 2px solid #ecf0f1;
      }

      .table td {
        padding: 12px;
        border-bottom: 1px solid #ecf0f1;
      }

      .table tr:hover {
        background: #f9fafb;
      }

      .status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }

      .status-success {
        background: #d1fae5;
        color: #065f46;
      }

      .status-warning {
        background: #fef3c7;
        color: #92400e;
      }

      .status-pending {
        background: #dbeafe;
        color: #1e40af;
      }

      /* PATIENT CARD */
      .patient-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        border: 1px solid #e0e6ed;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .patient-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
      }

      .patient-name {
        font-size: 16px;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
      }

      .patient-mrn {
        font-size: 13px;
        color: #667eea;
        margin-bottom: 10px;
      }

      .patient-info {
        display: flex;
        gap: 20px;
        font-size: 13px;
        color: #7f8c8d;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #ecf0f1;
      }

      /* PROGRESS */
      .progress-bar {
        background: #ecf0f1;
        height: 6px;
        border-radius: 3px;
        overflow: hidden;
        margin-top: 8px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        transition: width 0.3s ease;
      }

      /* FINDING ITEM */
      .finding-item {
        background: #f9fafb;
        border-left: 4px solid #667eea;
        padding: 16px;
        margin-bottom: 12px;
        border-radius: 6px;
      }

      .finding-title {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 6px;
      }

      .finding-location {
        font-size: 12px;
        color: #667eea;
        margin-bottom: 8px;
      }

      .finding-description {
        font-size: 13px;
        color: #555;
        line-height: 1.5;
      }

      .finding-confidence {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 10px;
        font-size: 12px;
      }

      /* SUCCESS/ERROR MESSAGES */
      .message {
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 15px;
        font-size: 14px;
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          transform: translateX(-20px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .success-message {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #6ee7b7;
      }

      .error-message {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fca5a5;
      }

      .info-message {
        background: #dbeafe;
        color: #1e40af;
        border: 1px solid #93c5fd;
      }

      /* LOADING */
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #e0e6ed;
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* RESPONSIVE */
      @media (max-width: 1200px) {
        .grid-3 {
          grid-template-columns: 1fr 1fr;
        }
        .grid-4 {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 768px) {
        .sidebar {
          width: 200px;
          padding: 20px 10px;
        }
        .main-content {
          margin-left: 200px;
        }
        .grid-2,
        .grid-3,
        .grid-4 {
          grid-template-columns: 1fr;
        }
        .page-title {
          font-size: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- SIDEBAR -->
      <aside class="sidebar">
        <div class="app-logo">
          <div class="app-logo-icon">M</div>
          <div>MediScan</div>
        </div>
        <nav class="nav-menu">
          <li class="nav-item">
            <a class="nav-link active" onclick="showPage('dashboard', this)">
              <div class="nav-icon">â¬š</div>
              <span>Dashboard</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" onclick="showPage('patients', this)">
              <div class="nav-icon">ðŸ‘¥</div>
              <span>Patients</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" onclick="showPage('analysis', this)">
              <div class="nav-icon">ðŸ”¬</div>
              <span>Analysis</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" onclick="showPage('reports', this)">
              <div class="nav-icon">ðŸ“‹</div>
              <span>Reports</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" onclick="showPage('settings', this)">
              <div class="nav-icon">âš™</div>
              <span>Settings</span>
            </a>
          </li>
        </nav>
      </aside>

      <!-- MAIN CONTENT -->
      <div class="main-content">
        <!-- HEADER -->
        <header>
          <div class="header-left">
            <div class="breadcrumb">
              <span id="currentPage">Dashboard</span>
            </div>
          </div>
          <div class="header-right">
            <div class="user-badge">
              <div class="user-avatar">A</div>
              <div>Admin</div>
            </div>
          </div>
        </header>

        <!-- CONTENT -->
        <section class="content-area">
          <!-- PAGE: DASHBOARD -->
          <div id="dashboard" class="page active">
            <div class="page-title">Dashboard</div>
            <div style="margin-top: 30px">
              <div class="grid-4">
                <div class="stat-card">
                  <div class="stat-value" id="totalPatients">0</div>
                  <div class="stat-label">Total Patients</div>
                </div>
                <div class="stat-card">
                  <div class="stat-value" id="totalScans">0</div>
                  <div class="stat-label">Total Scans</div>
                </div>
                <div class="stat-card">
                  <div class="stat-value" id="analysisAccuracy">0%</div>
                  <div class="stat-label">Avg Confidence</div>
                </div>
                <div class="stat-card">
                  <div class="stat-value" id="processingTime">0ms</div>
                  <div class="stat-label">Avg Processing</div>
                </div>
              </div>

              <div style="margin-top: 30px">
                <div class="card">
                  <div class="card-header">
                    <h2 class="card-title">Recent Activity</h2>
                  </div>
                  <table class="table">
                    <thead>
                      <tr>
                        <th>Patient</th>
                        <th>Scan Type</th>
                        <th>Date</th>
                        <th>Confidence</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody id="recentActivity">
                      <tr>
                        <td
                          colspan="5"
                          style="text-align: center; color: #7f8c8d"
                        >
                          No data available
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- PAGE: PATIENTS -->
          <div id="patients" class="page">
            <div class="page-title">Patient Management</div>
            <div style="margin-top: 30px">
              <div style="display: flex; gap: 10px; margin-bottom: 20px">
                <button class="btn btn-primary" onclick="showAddPatientForm()">
                  Add New Patient
                </button>
                <input
                  type="text"
                  class="form-control"
                  id="patientSearch"
                  placeholder="Search patients..."
                  style="flex: 1"
                  oninput="searchPatients()"
                />
              </div>

              <div
                id="addPatientFormContainer"
                style="display: none; margin-bottom: 20px"
              >
                <div class="card">
                  <div class="card-title">Add New Patient</div>
                  <div style="margin-top: 20px">
                    <div class="grid-2">
                      <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input
                          type="text"
                          class="form-control"
                          id="newPatientName"
                          placeholder="Enter patient name"
                        />
                      </div>
                      <div class="form-group">
                        <label class="form-label">MRN</label>
                        <input
                          type="text"
                          class="form-control"
                          id="newPatientMRN"
                          placeholder="Medical Record Number"
                        />
                      </div>
                    </div>
                    <div class="grid-2">
                      <div class="form-group">
                        <label class="form-label">Date of Birth</label>
                        <input
                          type="date"
                          class="form-control"
                          id="newPatientDOB"
                        />
                      </div>
                      <div class="form-group">
                        <label class="form-label">Age</label>
                        <input
                          type="number"
                          class="form-control"
                          id="newPatientAge"
                          placeholder="Age in years"
                        />
                      </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px">
                      <button class="btn btn-primary" onclick="addNewPatient()">
                        Save Patient
                      </button>
                      <button
                        class="btn btn-secondary"
                        onclick="hideAddPatientForm()"
                      >
                        Cancel
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="grid-2" id="patientsList"></div>
            </div>
          </div>

          <!-- PAGE: ANALYSIS -->
          <div id="analysis" class="page">
            <div class="page-title">Medical Image Analysis</div>
            <div style="margin-top: 30px">
              <div class="grid-2">
                <!-- UPLOAD SECTION -->
                <div class="card">
                  <div class="card-title">Image Upload</div>
                  <div style="margin-top: 20px">
                    <div class="upload-area" id="uploadArea">
                      <div class="upload-icon">â–²</div>
                      <div class="upload-text">Click to upload scan image</div>
                      <div class="upload-hint">PNG, JPG, JPEG (up to 50MB)</div>
                    </div>
                    <input
                      type="file"
                      id="imageInput"
                      accept="image/*"
                      style="display: none"
                    />
                    <div
                      id="imagePreview"
                      style="margin-top: 20px; display: none"
                    >
                      <img
                        id="previewImage"
                        style="max-width: 100%; border-radius: 6px"
                      />
                    </div>
                  </div>
                </div>

                <!-- STATUS SECTION -->
                <div class="card">
                  <div class="card-title">Analysis Status</div>
                  <div style="margin-top: 20px">
                    <div id="loadingStatus" style="display: none">
                      <div style="text-align: center">
                        <div class="loading-spinner"></div>
                        <div style="margin-top: 15px; color: #7f8c8d">
                          Processing image...
                        </div>
                      </div>
                    </div>
                    <div id="statusContent" style="display: none">
                      <div style="font-size: 13px; color: #7f8c8d">
                        <div
                          style="
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 10px;
                          "
                        >
                          <span>Image Type</span>
                          <span id="statusImageType">-</span>
                        </div>
                        <div
                          style="
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 10px;
                          "
                        >
                          <span>Body Part</span>
                          <span id="statusBodyPart">-</span>
                        </div>
                        <div
                          style="
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 10px;
                          "
                        >
                          <span>Ensemble Confidence</span>
                          <span id="statusConfidence">-</span>
                        </div>
                        <div
                          style="display: flex; justify-content: space-between"
                        >
                          <span>Processing Time</span>
                          <span id="statusTime">-</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ANALYSIS RESULTS -->
              <div
                id="resultsContainer"
                style="display: none; margin-top: 30px"
              >
                <div class="grid-2">
                  <!-- FINDINGS -->
                  <div class="card">
                    <div class="card-title">Clinical Findings</div>
                    <div id="findingsList" style="margin-top: 20px"></div>
                  </div>

                  <!-- HYPOTHESES -->
                  <div class="card">
                    <div class="card-title">Diagnostic Impression</div>
                    <div id="hypothesisList" style="margin-top: 20px"></div>
                  </div>
                </div>

                <!-- VERIFICATION & NOTES -->
                <div class="card" style="margin-top: 20px">
                  <div class="card-title">Verification Panel</div>
                  <div style="margin-top: 20px">
                    <div class="form-group">
                      <label class="form-label">Send for Review To</label>
                      <select class="form-control" id="doctorSelect">
                        <option>Dr. Smith</option>
                        <option>Dr. Johnson</option>
                        <option>Dr. Patel</option>
                        <option>Dr. Wilson</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label class="form-label">Clinical Notes</label>
                      <textarea
                        class="form-control"
                        id="clinicalNotes"
                        placeholder="Add clinical observations and notes..."
                      ></textarea>
                    </div>
                    <div style="display: flex; gap: 10px">
                      <button class="btn btn-primary" onclick="sendForReview()">
                        Send for Review
                      </button>
                      <button class="btn btn-success" onclick="saveAnalysis()">
                        Approve & Save
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- PAGE: REPORTS -->
          <div id="reports" class="page">
            <div class="page-title">Analysis Reports</div>
            <div style="margin-top: 30px">
              <div class="card">
                <div class="card-header">
                  <h2 class="card-title">Saved Reports</h2>
                  <button class="btn btn-secondary">Export</button>
                </div>
                <table class="table">
                  <thead>
                    <tr>
                      <th>Patient</th>
                      <th>Scan Type</th>
                      <th>Date</th>
                      <th>Body Part</th>
                      <th>Findings</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="reportsList">
                    <tr>
                      <td
                        colspan="6"
                        style="text-align: center; color: #7f8c8d"
                      >
                        No reports available
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- PAGE: SETTINGS -->
          <div id="settings" class="page">
            <div class="page-title">Settings</div>
            <div style="margin-top: 30px">
              <div class="card">
                <div class="card-title">System Configuration</div>
                <div style="margin-top: 20px">
                  <div class="form-group">
                    <label class="form-label">Analysis Model</label>
                    <select class="form-control" id="modelSelect">
                      <option>
                        Ensemble (ResNet50 + DenseNet + EfficientNet + Vision
                        Transformer)
                      </option>
                      <option>ResNet50 Only</option>
                      <option>DenseNet Only</option>
                      <option>Fast Mode (Single Model)</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Confidence Threshold</label>
                    <input
                      type="range"
                      class="form-control"
                      min="0"
                      max="100"
                      value="70"
                    />
                    <div
                      style="font-size: 12px; color: #7f8c8d; margin-top: 5px"
                    >
                      Current: 70%
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Auto-save Reports</label>
                    <input type="checkbox" checked /> Enable automatic report
                    generation
                  </div>
                  <button class="btn btn-primary" style="margin-top: 15px">
                    Save Settings
                  </button>
                </div>
              </div>

              <div class="card" style="margin-top: 20px">
                <div class="card-title">About</div>
                <div style="margin-top: 20px; font-size: 14px; color: #555">
                  <div>MediScan Analyst v2.0</div>
                  <div style="color: #7f8c8d; margin-top: 10px">
                    Advanced Medical Image Analysis System
                  </div>
                  <div style="color: #7f8c8d; margin-top: 5px">
                    Powered by Ensemble ML (4 models: ResNet50, DenseNet121,
                    EfficientNet-B3, Vision Transformer)
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <script>
      const API_URL = "http://localhost:8000";
      let currentAnalysis = null;
      let patients = JSON.parse(localStorage.getItem("patients")) || [];
      let reports = JSON.parse(localStorage.getItem("reports")) || [];
      let selectedPatitentForAnalysis = null;

      // PAGE NAVIGATION
      function showPage(pageId, element) {
        document
          .querySelectorAll(".page")
          .forEach((p) => p.classList.remove("active"));
        document.getElementById(pageId).classList.add("active");

        document
          .querySelectorAll(".nav-link")
          .forEach((l) => l.classList.remove("active"));
        element.classList.add("active");

        document.getElementById("currentPage").textContent =
          pageId.charAt(0).toUpperCase() + pageId.slice(1);

        // Update page-specific content
        if (pageId === "dashboard") updateDashboard();
        if (pageId === "patients") loadPatients();
        if (pageId === "reports") loadReports();
      }

      // DASHBOARD
      function updateDashboard() {
        const totalScansCount = patients.reduce(
          (sum, p) => sum + (p.scans ? p.scans.length : 0),
          0,
        );
        const avgConfidence =
          patients.length > 0
            ? (
                (patients.reduce(
                  (sum, p) =>
                    sum +
                    (p.scans
                      ? p.scans.reduce(
                          (s, scan) => s + (scan.ensemble_confidence || 0),
                          0,
                        ) / (p.scans.length || 1)
                      : 0),
                  0,
                ) /
                  patients.length) *
                100
              ).toFixed(1)
            : 0;

        document.getElementById("totalPatients").textContent = patients.length;
        document.getElementById("totalScans").textContent = totalScansCount;
        document.getElementById("analysisAccuracy").textContent =
          avgConfidence + "%";

        // Recent activity
        const recentScans = [];
        patients.forEach((p) => {
          if (p.scans) {
            p.scans.forEach((scan) => {
              recentScans.push({ patient: p.name, ...scan });
            });
          }
        });
        recentScans.sort(
          (a, b) => new Date(b.timestamp) - new Date(a.timestamp),
        );

        const activity = document.getElementById("recentActivity");
        if (recentScans.length === 0) {
          activity.innerHTML =
            '<tr><td colspan="5" style="text-align: center; color: #7f8c8d;">No data available</td></tr>';
        } else {
          activity.innerHTML = recentScans
            .slice(0, 10)
            .map(
              (scan) => `
                    <tr>
                        <td><strong>${scan.patient}</strong></td>
                        <td>${scan.image_type}</td>
                        <td>${new Date(scan.timestamp).toLocaleDateString()}</td>
                        <td>${(scan.ensemble_confidence * 100).toFixed(1)}%</td>
                        <td><span class="status-badge status-success">Saved</span></td>
                    </tr>
                `,
            )
            .join("");
        }
      }

      // PATIENTS
      function loadPatients() {
        const container = document.getElementById("patientsList");
        if (patients.length === 0) {
          container.innerHTML =
            '<div style="grid-column: 1/-1; text-align: center; color: #7f8c8d; padding: 40px;">No patients yet. Add one to get started.</div>';
          return;
        }

        container.innerHTML = patients
          .map(
            (p) => `
                <div class="patient-card">
                    <div class="patient-name">${p.name}</div>
                    <div class="patient-mrn">MRN: ${p.mrn}</div>
                    <div class="patient-info">
                        <span>Age: ${p.age}</span>
                        <span>Scans: ${p.scans ? p.scans.length : 0}</span>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn btn-primary" style="flex: 1; font-size: 12px;" onclick="selectPatientForAnalysis('${p.mrn}')">Analyze</button>
                        <button class="btn btn-secondary" style="flex: 1; font-size: 12px;" onclick="viewPatientProfile('${p.mrn}')">Details</button>
                        <button class="btn btn-danger" style="flex: 1; font-size: 12px;" onclick="deletePatient('${p.mrn}')">Delete</button>
                    </div>
                </div>
            `,
          )
          .join("");
      }

      function showAddPatientForm() {
        document.getElementById("addPatientFormContainer").style.display =
          "block";
      }

      function hideAddPatientForm() {
        document.getElementById("addPatientFormContainer").style.display =
          "none";
      }

      function addNewPatient() {
        const name = document.getElementById("newPatientName").value;
        const mrn = document.getElementById("newPatientMRN").value;
        const dob = document.getElementById("newPatientDOB").value;
        const age = document.getElementById("newPatientAge").value;

        if (!name || !mrn || !dob || !age) {
          alert("Please fill all fields");
          return;
        }

        const patient = {
          name,
          mrn,
          dob,
          age: parseInt(age),
          scans: [],
          notes: "",
        };
        patients.push(patient);
        localStorage.setItem("patients", JSON.stringify(patients));

        hideAddPatientForm();
        document.getElementById("newPatientName").value = "";
        document.getElementById("newPatientMRN").value = "";
        document.getElementById("newPatientDOB").value = "";
        document.getElementById("newPatientAge").value = "";

        loadPatients();
        showSuccessMessage("Patient added successfully");
      }

      function searchPatients() {
        const query = document
          .getElementById("patientSearch")
          .value.toLowerCase();
        const filtered = patients.filter(
          (p) =>
            p.name.toLowerCase().includes(query) ||
            p.mrn.toLowerCase().includes(query),
        );

        const container = document.getElementById("patientsList");
        container.innerHTML = filtered
          .map(
            (p) => `
                <div class="patient-card">
                    <div class="patient-name">${p.name}</div>
                    <div class="patient-mrn">MRN: ${p.mrn}</div>
                    <div class="patient-info">
                        <span>Age: ${p.age}</span>
                        <span>Scans: ${p.scans ? p.scans.length : 0}</span>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn btn-primary" style="flex: 1; font-size: 12px;" onclick="selectPatientForAnalysis('${p.mrn}')">Analyze</button>
                        <button class="btn btn-secondary" style="flex: 1; font-size: 12px;" onclick="viewPatientProfile('${p.mrn}')">Details</button>
                        <button class="btn btn-danger" style="flex: 1; font-size: 12px;" onclick="deletePatient('${p.mrn}')">Delete</button>
                    </div>
                </div>
            `,
          )
          .join("");
      }

      function deletePatient(mrn) {
        if (confirm("Delete this patient and all scans?")) {
          patients = patients.filter((p) => p.mrn !== mrn);
          localStorage.setItem("patients", JSON.stringify(patients));
          loadPatients();
          showSuccessMessage("Patient deleted");
        }
      }

      function selectPatientForAnalysis(mrn) {
        selectedPatitentForAnalysis = mrn;
        showPage(
          "analysis",
          document.querySelector("[onclick*=\"showPage('analysis'\"]"),
        );
        showSuccessMessage("Patient selected for analysis");
      }

      function viewPatientProfile(mrn) {
        const patient = patients.find((p) => p.mrn === mrn);
        console.log("Patient Profile:", patient);
      }

      // ANALYSIS
      const uploadArea = document.getElementById("uploadArea");
      const imageInput = document.getElementById("imageInput");

      uploadArea.addEventListener("click", () => imageInput.click());
      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      });
      uploadArea.addEventListener("dragleave", () =>
        uploadArea.classList.remove("dragover"),
      );
      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        const files = e.dataTransfer.files;
        if (files.length > 0) handleImageSelect(files[0]);
      });

      imageInput.addEventListener("change", (e) => {
        if (e.target.files.length > 0) handleImageSelect(e.target.files[0]);
      });

      function handleImageSelect(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const preview = document.getElementById("imagePreview");
          document.getElementById("previewImage").src = e.target.result;
          preview.style.display = "block";
          analyzeImage(file);
        };
        reader.readAsDataURL(file);
      }

      async function analyzeImage(file) {
        const formData = new FormData();
        formData.append("file", file);

        document.getElementById("loadingStatus").style.display = "block";
        document.getElementById("statusContent").style.display = "none";
        document.getElementById("resultsContainer").style.display = "none";

        try {
          const response = await fetch(`${API_URL}/api/analyze`, {
            method: "POST",
            body: formData,
          });

          if (!response.ok) throw new Error("Analysis failed");

          currentAnalysis = await response.json();

          document.getElementById("loadingStatus").style.display = "none";
          document.getElementById("statusContent").style.display = "block";

          document.getElementById("statusImageType").textContent =
            currentAnalysis.image_type;
          document.getElementById("statusBodyPart").textContent =
            currentAnalysis.body_part;
          document.getElementById("statusConfidence").textContent =
            (currentAnalysis.ensemble_confidence * 100).toFixed(1) + "%";
          document.getElementById("statusTime").textContent =
            currentAnalysis.processing_time.toFixed(2) + "s";

          displayFindings(currentAnalysis.analysis.findings);
          displayHypotheses(currentAnalysis.analysis);

          document.getElementById("resultsContainer").style.display = "block";
        } catch (error) {
          showErrorMessage("Analysis failed: " + error.message);
          document.getElementById("loadingStatus").style.display = "none";
        }
      }

      function displayFindings(findings) {
        const container = document.getElementById("findingsList");
        container.innerHTML = findings
          .map(
            (f, i) => `
                <div class="finding-item">
                    <div class="finding-title">${f.finding_type}</div>
                    <div class="finding-location">${f.location}</div>
                    <div class="finding-description">${f.description}</div>
                    <div class="finding-confidence">
                        <span>Confidence:</span>
                        <span>${(f.confidence * 100).toFixed(1)}%</span>
                        <div class="progress-bar" style="flex: 1; margin-left: 10px;">
                            <div class="progress-fill" style="width: ${f.confidence * 100}%"></div>
                        </div>
                    </div>
                </div>
            `,
          )
          .join("");
      }

      function displayHypotheses(analysis) {
        const container = document.getElementById("hypothesisList");
        const hypotheses = [
          { ...analysis.primary_hypothesis, type: "Primary" },
          ...analysis.differential_diagnoses.map((h, i) => ({
            ...h,
            type: `Differential ${i + 1}`,
          })),
        ];

        container.innerHTML = hypotheses
          .map(
            (h) => `
                <div class="finding-item" style="border-left-color: ${h.type === "Primary" ? "#10b981" : "#667eea"};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong>${h.condition}</strong>
                        <span class="status-badge ${h.probability > 0.7 ? "status-success" : h.probability > 0.5 ? "status-warning" : "status-pending"}">
                            ${(h.probability * 100).toFixed(1)}%
                        </span>
                    </div>
                    <div style="font-size: 13px; color: #555; margin-bottom: 10px;">${h.reasoning}</div>
                    <div style="font-size: 12px; color: #7f8c8d;">Risk Level: <strong>${h.risk_level}</strong></div>
                </div>
            `,
          )
          .join("");
      }

      function sendForReview() {
        if (!currentAnalysis || !selectedPatitentForAnalysis) {
          showErrorMessage("No analysis to review");
          return;
        }
        const doctor = document.getElementById("doctorSelect").value;
        showSuccessMessage(`Analysis sent to ${doctor} for review`);
      }

      function saveAnalysis() {
        if (!currentAnalysis || !selectedPatitentForAnalysis) {
          showErrorMessage("No analysis to save");
          return;
        }

        const patient = patients.find(
          (p) => p.mrn === selectedPatitentForAnalysis,
        );
        const notes = document.getElementById("clinicalNotes").value;

        const scan = {
          timestamp: new Date().toISOString(),
          image_type: currentAnalysis.image_type,
          body_part: currentAnalysis.body_part,
          analysis: currentAnalysis.analysis,
          ensemble_confidence: currentAnalysis.ensemble_confidence,
          notes: notes,
        };

        patient.scans.push(scan);
        localStorage.setItem("patients", JSON.stringify(patients));

        reports.push({
          patient_mrn: selectedPatitentForAnalysis,
          patient_name: patient.name,
          ...scan,
        });
        localStorage.setItem("reports", JSON.stringify(reports));

        showSuccessMessage("Analysis saved to patient profile");
        resetAnalysis();
      }

      function resetAnalysis() {
        currentAnalysis = null;
        document.getElementById("imageInput").value = "";
        document.getElementById("imagePreview").style.display = "none";
        document.getElementById("resultsContainer").style.display = "none";
        document.getElementById("statusContent").style.display = "none";
        document.getElementById("clinicalNotes").value = "";
      }

      // REPORTS
      function loadReports() {
        const container = document.getElementById("reportsList");
        if (reports.length === 0) {
          container.innerHTML =
            '<tr><td colspan="6" style="text-align: center; color: #7f8c8d;">No reports saved</td></tr>';
          return;
        }

        container.innerHTML = reports
          .map(
            (r) => `
                <tr>
                    <td><strong>${r.patient_name}</strong></td>
                    <td>${r.image_type}</td>
                    <td>${new Date(r.timestamp).toLocaleDateString()}</td>
                    <td>${r.body_part}</td>
                    <td>${r.analysis.findings.length} findings</td>
                    <td><span class="status-badge status-success">Saved</span></td>
                </tr>
            `,
          )
          .join("");
      }

      // MESSAGES
      function showSuccessMessage(message) {
        const div = document.createElement("div");
        div.className = "message success-message";
        div.textContent = "SUCCESS: " + message;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 3000);
      }

      function showErrorMessage(message) {
        const div = document.createElement("div");
        div.className = "message error-message";
        div.textContent = "ERROR: " + message;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 3000);
      }

      // INIT
      function init() {
        loadPatients();
        updateDashboard();
      }

      init();
    </script>
  </body>
</html>
